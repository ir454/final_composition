<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio-Visual Sculpture</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; }
        canvas { display: block; }
    </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<script>
/* ===============================
   Setup Three.js Scene
   =============================== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

const camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
);
camera.position.set(0, 5, 20);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* ===============================
   Add Lights
   =============================== */
const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
scene.add(ambientLight);

const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
directionalLight.position.set(5, 10, 7);
scene.add(directionalLight);

/* ===============================
   Audio Setup
   =============================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

/* Function to create a spatialized oscillator */
function createOscillator(x, y, z, freq) {
    const oscillator = audioCtx.createOscillator();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);

    const panner = audioCtx.createPanner();
    panner.panningModel = 'HRTF';
    panner.distanceModel = 'inverse';
    panner.positionX.setValueAtTime(x, audioCtx.currentTime);
    panner.positionY.setValueAtTime(y, audioCtx.currentTime);
    panner.positionZ.setValueAtTime(z, audioCtx.currentTime);

    oscillator.connect(panner).connect(audioCtx.destination);
    oscillator.start();

    return { oscillator, panner };
}

/* ===============================
   Escher-Inspired Sculpture
   =============================== */
const sculpture = new THREE.Group();
scene.add(sculpture);

const geometry = new THREE.BoxGeometry(1, 1, 1);
const material = new THREE.MeshStandardMaterial({ color: 0x00ffcc, roughness: 0.3 });

const audioObjects = [];

const size = 5; // grid size
for (let x = -size; x <= size; x += 2) {
    for (let y = 0; y <= size * 2; y += 2) {
        for (let z = -size; z <= size; z += 2) {
            // Create cubes in a recursive, offset pattern
            const cube = new THREE.Mesh(geometry, material);
            cube.position.set(x + (y % 4), y, z + (x % 4));
            sculpture.add(cube);

            // Create oscillator at the cube's position
            const freq = 100 + Math.random() * 400; // random frequency
            const audioObj = createOscillator(cube.position.x, cube.position.y, cube.position.z, freq);
            audioObjects.push(audioObj);
        }
    }
}

/* ===============================
   Animate Scene
   =============================== */
function animate() {
    requestAnimationFrame(animate);

    // Rotate sculpture slowly
    sculpture.rotation.x += 0.001;
    sculpture.rotation.y += 0.002;

    // Optional: make cubes pulse to audio (visualization effect)
    sculpture.children.forEach((cube, idx) => {
        const scale = 0.5 + Math.sin(Date.now() * 0.001 + idx) * 0.5;
        cube.scale.set(scale, scale, scale);
    });

    // Update listener position to camera
    if (audioCtx.listener.positionX) { // modern API
        audioCtx.listener.positionX.setValueAtTime(camera.position.x, audioCtx.currentTime);
        audioCtx.listener.positionY.setValueAtTime(camera.position.y, audioCtx.currentTime);
        audioCtx.listener.positionZ.setValueAtTime(camera.position.z, audioCtx.currentTime);
    }

    renderer.render(scene, camera);
}
animate();

/* ===============================
   Handle Window Resize
   =============================== */
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

/* ===============================
   User Interaction to Resume Audio
   =============================== */
document.body.addEventListener('click', () => {
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
});
</script>
</body>
</html>
