<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Melodic Sequencer Sculpture</title>
<style>
  body { margin:0; overflow:hidden; background:#111; }
  canvas { display:block; }
</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
/* ===============================
   THREE.JS SETUP
   =============================== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
camera.position.set(0, 10, 25);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* LIGHTS */
scene.add(new THREE.AmbientLight(0xffffff, 0.5));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
dirLight.position.set(30,50,30);
scene.add(dirLight);

/* ===============================
   CREATE SMALL CENTERED SCULPTURE
   =============================== */
const sculpture = new THREE.Group();
scene.add(sculpture);

const cubeGeometry = new THREE.BoxGeometry(1,1,1);
const cubeMaterial = new THREE.MeshBasicMaterial({color:0x00ffcc, wireframe:true});

const cubes = [];
const gridX = 5;
const gridY = 4;
const spacing = 2;

for(let x=0; x<gridX; x++){
  for(let y=0; y<gridY; y++){
    const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
    const posX = (x - (gridX-1)/2)*spacing;
    const posY = (y - (gridY-1)/2)*spacing;
    cube.position.set(posX, posY, 0);
    sculpture.add(cube);

    cubes.push({
      mesh: cube,
      basePos: cube.position.clone(),
      phase: Math.random()*Math.PI*2,
      scalePulse: 0
    });
  }
}

/* ===============================
   WEB AUDIO SETUP
   =============================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const Cminor = [261.63, 311.13, 392.00, 523.25]; // C, Eb, G, C5
let cubeIndex = 0;

function playNote(freq, cube){
  const osc = audioCtx.createOscillator();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

  const gain = audioCtx.createGain();
  gain.gain.setValueAtTime(0.05, audioCtx.currentTime);

  const panner = audioCtx.createPanner();
  panner.panningModel = 'HRTF';
  panner.distanceModel = 'inverse';
  panner.positionX.setValueAtTime(cube.mesh.position.x, audioCtx.currentTime);
  panner.positionY.setValueAtTime(cube.mesh.position.y, audioCtx.currentTime);
  panner.positionZ.setValueAtTime(cube.mesh.position.z, audioCtx.currentTime);

  osc.connect(panner).connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.25);

  cube.scalePulse = 0.5;
}

/* ===============================
   ANIMATE SCENE
   =============================== */
function animate(){
  requestAnimationFrame(animate);
  const t = performance.now()*0.001;

  cubes.forEach((c)=>{
    // subtle floating motion
    const floatX = Math.sin(t + c.phase)*0.2;
    const floatY = Math.cos(t*1.5 + c.phase)*0.2;
    c.mesh.position.x = c.basePos.x + floatX;
    c.mesh.position.y = c.basePos.y + floatY;

    // rotation
    c.mesh.rotation.x = t*0.2 + c.phase;
    c.mesh.rotation.y = t*0.25 + c.phase;

    // scale pulse
    c.scalePulse *= 0.85;
    const scale = 0.8 + c.scalePulse;
    c.mesh.scale.set(scale, scale, scale);
  });

  sculpture.rotation.y += 0.0015;
  renderer.render(scene, camera);

  // Melodic sequencer: play each cube in order
  if(!animate.lastPlay) animate.lastPlay = t;
  if(t - animate.lastPlay > 0.3){
    const freq = Cminor[cubeIndex % Cminor.length];
    playNote(freq, cubes[cubeIndex]);
    cubeIndex = (cubeIndex + 1) % cubes.length;
    animate.lastPlay = t;
  }
}
animate();

/* ===============================
   HANDLE RESIZE
   =============================== */
window.addEventListener('resize', ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

/* CLICK TO START AUDIO CONTEXT */
document.body.addEventListener('click', ()=>{
  if(audioCtx.state === 'suspended') audioCtx.resume();
});
</script>
</body>
</html>
